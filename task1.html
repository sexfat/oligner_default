<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OLigner TW丨開啟微笑旅程</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body class="task">
    <div class="container">
        <h1>免費線上評估</h1>

        <form id="task-form-1">
            <input type="hidden" name="task_name" value="留下資料（拍照）">
            <input type="hidden" id="selected-condition" name="condition" value="">
            <input type="hidden" id="calculated-age" name="age">

            <div class="form-group">
                <label for="name">姓名</label>
                <input type="text" id="name" name="name" required>
            </div>

            <div class="form-group">
                <label for="rocYear">出生年（民國）</label>
                <input type="number" id="rocYear" name="rocYear" max="200" placeholder="例如：81" required>
                <small id="rocYear-warning" style="color: red; display: none;">民國年不得超過 200</small>
            </div>

            <div class="form-group">
                <label for="phone">電話</label>
                <input type="tel" id="phone" name="phone" placeholder="09xxxxxxxx" maxlength="10" pattern="^09[0-9]{8}$"
                    required>
                <small id="phone-info">電話格式：09 開頭，共 10 位數字</small>
            </div>

            <!-- 狀況選擇 -->
            <div class="form-group boxcenter">
                <label>諮詢項目 <b>（可複選）</b></label>
                <div class="image-options task">
                    <img src="images/status1.jpg" class="condition-image" data-value="排列擁擠" alt="排列擁擠">
                    <img src="images/status2.jpg" class="condition-image" data-value="暴牙/兔寶寶" alt="暴牙/兔寶寶">
                    <img src="images/status3.jpg" class="condition-image" data-value="牙縫過大" alt="牙縫過大">
                    <img src="images/status4.jpg" class="condition-image" data-value="戽斗" alt="戽斗">
                </div>
                <button class="uncertain-button" type="button" id="uncertain-button">我不確定</button>
            </div>

            <!-- 縣市選擇 -->
            <div class="form-group">
                <label for="city">居住縣市：</label>
                <select id="city" name="city" required>
                    <option value="" selected disabled>請選擇縣市</option>
                </select>
            </div>

            <!-- 區域選擇 -->
            <div class="form-group">
                <label for="region">區域別：</label>
                <select id="region" name="region" required>
                    <option value="" selected disabled>請先選擇縣市</option>
                </select>
            </div>

            <div class="form-group">
                <label for="email">信箱：</label>
                <input type="email" id="email" name="email" placeholder="例如：oligner@example.com">
                <small id="email-warning" style="color: red; display: none;">信箱必須包含 @ 符號</small>
            </div>

            <!--隱私權  -->
            <div class="privacy-container">
                <input type="checkbox" id="privacy-checkbox">
                <label for="privacy-checkbox">我已閱讀並同意<a href="#" id="privacy-button">隱私條款</a></label>
            </div>

            <button type="button" id="next-button" disabled>下一步，拍照</button>
        </form>

        <a href="index.html" class="back-button">回上一頁</a>
        <footer>
            <p>© <span id="year"></span> OLigner 歐耐恩隱形矯正
                <br>all rights reserved 版權所有
            </p>
            <h1 class="next71">製作公司: <a href="https://www.71next.com/" target="_blank"
                    rel="noopener noreferrer">秦毅數位科技現有公司</a>
            </h1>
        </footer>
        <div id="privacy-modal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h1>歐耐恩隱私權政策</h1>
                <p>非常歡迎您光臨「歐耐恩OLigner網站」（以下簡稱本網站），為了讓您能夠安心使用本網站的各項服務與資訊，特此向您說明本網站的隱私權保護政策，以保障您的權益，請您詳閱下列內容：</p>

                <h2>一、隱私權保護政策的適用範圍</h2>
                <p>隱私權保護政策內容，包括本網站如何處理在您使用網站服務時收集到的個人識別資料。隱私權保護政策不適用於本網站以外的相關連結網站，也不適用於非本網站所委託或參與管理的人員。</p>

                <h2>二、個人資料的蒐集、處理及利用方式</h2>
                <p>當您造訪本網站或使用本網站所提供之功能服務時，我們將視該服務功能性質，請您提供必要的個人資料，並在該特定目的範圍內處理及利用您的個人資料；非經您書面同意，本網站不會將個人資料用於其他用途。</p>
                <p>本網站在您使用服務信箱、問卷調查等互動性功能時，會保留您所提供的姓名、電子郵件地址、聯絡方式及使用時間等。</p>
                <p>於一般瀏覽時，伺服器會自行記錄相關行徑，包括您使用連線設備的IP位址、使用時間、使用的瀏覽器、瀏覽及點選資料記錄等，做為我們增進網站服務的參考依據，此記錄為內部應用，決不對外公佈。</p>
                <p>為提供精確的服務，我們會將收集的問卷調查內容進行統計與分析，分析結果之統計數據或說明文字呈現，除供內部研究外，我們會視需要公佈統計數據及說明文字，但不涉及特定個人之資料。</p>
                <p>您可以隨時向我們提出請求，以更正或刪除本網站所蒐集您錯誤或不完整的個人資料。</p>

                <h2>三、資料之保護</h2>
                <p>本網站主機均設有防火牆、防毒系統等相關的各項資訊安全設備及必要的安全防護措施，加以保護網站及您的個人資料採用嚴格的保護措施，只由經過授權的人員才能接觸您的個人資料，相關處理人員皆簽有保密合約，如有違反保密義務者，將會受到相關的法律處分。
                </p>
                <p>如因業務需要有必要委託其他單位提供服務時，本網站亦會嚴格要求其遵守保密義務，並且採取必要檢查程序以確定其將確實遵守。</p>

                <h2>四、網站對外的相關連結</h2>
                <p>本網站的網頁提供其他網站的網路連結，您也可經由本網站所提供的連結，點選進入其他網站。但該連結網站不適用本網站的隱私權保護政策，您必須參考該連結網站中的隱私權保護政策。</p>

                <h2>五、與第三人共用個人資料之政策</h2>
                <p>本網站絕不會提供、交換、出租或出售任何您的個人資料給其他個人、團體、私人企業或公務機關，但有法律依據或合約義務者，不在此限。前項但書之情形包括不限於：</p>
                <ul>
                    <li>經由您書面同意。</li>
                    <li>法律明文規定。</li>
                    <li>為免除您生命、身體、自由或財產上之危險。</li>
                    <li>與公務機關或學術研究機構合作，基於公共利益為統計或學術研究而有必要，且資料經過提供者處理或蒐集著依其揭露方式無從識別特定之當事人。</li>
                    <li>當您在網站的行為，違反服務條款或可能損害或妨礙網站與其他使用者權益或導致任何人遭受損害時，經網站管理單位研析揭露您的個人資料是為了辨識、聯絡或採取法律行動所必要者。</li>
                    <li>有利於您的權益。</li>
                </ul>
                <p>本網站委託廠商協助蒐集、處理或利用您的個人資料時，將對委外廠商或個人善盡監督管理之責。</p>

                <h2>六、Cookie之使用</h2>
                <p>為了提供您最佳的服務，本網站會在您的電腦中放置並取用我們的Cookie，若您不願接受Cookie的寫入，您可在您使用的瀏覽器功能項中設定隱私權等級為高，即可拒絕Cookie的寫入，但可能會導至網站某些功能無法正常執行。
                </p>

                <h2>七、隱私權保護政策之修正</h2>
                <p>本網站隱私權保護政策將因應需求隨時進行修正，修正後的條款將刊登於網站上。</p>
            </div>
        </div>
    </div>

    <script>
        const citySelect = document.getElementById('city');
        const regionSelect = document.getElementById('region');
        const conditionImages = document.querySelectorAll('.condition-image');
        const uncertainButton = document.getElementById('uncertain-button');
        const selectedConditionInput = document.getElementById('selected-condition');
        const nextButton = document.getElementById('next-button');
        const phoneInput = document.getElementById('phone');
        const phoneInfo = document.getElementById('phone-info');
        const calculatedAgeInput = document.getElementById('calculated-age');
        const rocYearInput = document.getElementById('rocYear');
        const rocYearWarning = document.getElementById('rocYear-warning');
        const emailInput = document.getElementById('email');
        const emailWarning = document.getElementById('email-warning');
        const privacyCheckbox = document.getElementById('privacy-checkbox');

        let selectedConditions = [];

        //彈窗事件
        const modal = document.getElementById('privacy-modal');
        const privacyButton = document.getElementById('privacy-button');
        const closeButton = document.querySelector('.close-button');

        // 開啟彈窗
        privacyButton.addEventListener('click', () => {
            modal.classList.add('show');
        });

        // 關閉彈窗
        closeButton.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => {
            if (event.target === modal) closeModal();
        });

        function closeModal() {
            modal.classList.remove('show');
        }

        function calculateAge() {
            const currentYear = new Date().getFullYear();
            const rocYear = parseInt(document.getElementById("rocYear").value, 10);

            if (rocYear > 200) {
                rocYearWarning.style.display = 'block';
                nextButton.disabled = true;
                return;
            } else {
                rocYearWarning.style.display = 'none';
            }

            if (!rocYear) {
                return;
            }

            const birthYear = rocYear + 1911;
            const age = currentYear - birthYear;
            calculatedAgeInput.value = age;  // 儲存年齡於隱藏欄位
        }

        document.getElementById("rocYear").addEventListener("input", calculateAge);

        phoneInput.addEventListener('input', function () {
            const remainingDigits = 10 - phoneInput.value.length;
            phoneInfo.textContent = `電話格式：09 開頭，共 10 位數字，剩餘 ${remainingDigits} 位`;
            const isPhoneValid = phoneInput.value.match(/^09[0-9]{8}$/) !== null;
            phoneInput.setCustomValidity(isPhoneValid ? '' : '請填入有效的台灣手機號碼，09開頭共10位數');
            checkFormValidity();
        });
        emailInput.addEventListener('input', checkFormValidity);

        privacyCheckbox.addEventListener('change', checkFormValidity);

        function checkFormValidity() {
            const allFilled = requiredFields.every(field => field.value.trim() !== '');
            const conditionFilled = selectedConditionInput.value.trim() !== '';
            const isPhoneValid = phoneInput.value.match(/^09[0-9]{8}$/) !== null;
            const isEmailValid = emailInput.value === '' || emailInput.value.includes('@'); // 信箱可空白，若填寫需包含 '@'
            const isPrivacyChecked = privacyCheckbox.checked;

            nextButton.disabled = !(allFilled && conditionFilled && isPhoneValid && isEmailValid && isPrivacyChecked && rocYearWarning.style.display === 'none');

            // 顯示或隱藏信箱警告
            if (emailInput.value !== '' && !isEmailValid) {
                emailWarning.style.display = 'block';
            } else {
                emailWarning.style.display = 'none';
            }
        }

        emailInput.addEventListener('input', checkFormValidity);

        const form = document.getElementById('task-form-1');
        const requiredFields = Array.from(form.querySelectorAll('input[required], select[required]'));

        // 狀況圖片多選邏輯
        conditionImages.forEach(image => {
            image.addEventListener('click', function () {
                if (uncertainButton.classList.contains('selected')) {
                    uncertainButton.classList.remove('selected');
                    selectedConditions = [];
                }

                this.classList.toggle('selected');
                const value = this.getAttribute('data-value');

                if (this.classList.contains('selected')) {
                    selectedConditions.push(value);
                } else {
                    selectedConditions = selectedConditions.filter(cond => cond !== value);
                }

                selectedConditionInput.value = selectedConditions.join(', ');
                checkFormValidity();
            });
        });

        uncertainButton.addEventListener('click', function () {
            conditionImages.forEach(img => img.classList.remove('selected'));
            selectedConditions = [];
            this.classList.add('selected');
            selectedConditionInput.value = '我不確定';
            checkFormValidity();
        });

        fetch('regions.json')
            .then(response => response.json())
            .then(data => {
                Object.keys(data).forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });

                citySelect.addEventListener('change', () => {
                    const selectedCity = citySelect.value;
                    const regions = data[selectedCity] || [];
                    regionSelect.innerHTML = '<option value="" selected disabled>請選擇區域</option>';
                    regions.forEach(region => {
                        const option = document.createElement('option');
                        option.value = region;
                        option.textContent = region;
                        regionSelect.appendChild(option);
                    });
                });
            })
            .catch(error => console.error('無法載入縣市資料:', error));

        requiredFields.forEach(field => {
            field.addEventListener('input', checkFormValidity);
            field.addEventListener('change', checkFormValidity);
        });

        checkFormValidity();

        nextButton.addEventListener('click', () => {
            const formData = {
                task_name: form.task_name.value,
                condition: selectedConditionInput.value,
                name: form.name.value,
                rocYear: form.rocYear.value,
                age: calculatedAgeInput.value,  // 儲存計算後的年齡
                phone: form.phone.value,
                city: form.city.value,
                region: form.region.value,
                email: form.email.value
            };
            localStorage.setItem('taskData', JSON.stringify(formData));
            window.location.href = 'task1_camera.html';
        });
        // 獲取伺服器的當前年份
        const currentYear = new Date().getFullYear();

        // 將年份插入到指定的元素中
        document.getElementById("year").textContent = currentYear;
    </script>
</body>

</html>