<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OLigner TW丨開啟微笑旅程</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .banner {
            width: 100%;
            max-width: 550px;
        }

        .container {
            max-width: 550px;
        }
    </style>
</head>

<body>
    <div class="banner">
        <img src="banner/image01.jpg" alt="">
        <!-- 尺寸 836px 498px-->
    </div>
    <div class="container">
        <h1>免費線上評估</h1>

        <form id="task-form-1">
            <input type="hidden" name="task_name" value="留下資料（拍照）">
            <input type="hidden" id="selected-condition" name="condition" value="">
            <input type="hidden" id="calculated-age" name="age">

            <div class="form-group">
                <label for="name">姓名</label>
                <input type="text" id="name" name="name" required>
            </div>

            <div class="form-group">
                <label for="rocYear">出生年（民國）</label>
                <input type="number" id="rocYear" name="rocYear" max="200" placeholder="例如：81" required>
                <small id="rocYear-warning" style="color: red; display: none;">民國年不得超過 200</small>
            </div>

            <div class="form-group">
                <label for="phone">電話</label>
                <input type="tel" id="phone" name="phone" placeholder="09xxxxxxxx" maxlength="10" pattern="^09[0-9]{8}$"
                    required>
                <small id="phone-info">電話格式：09 開頭，共 10 位數字</small>
            </div>

            <!-- 狀況選擇 -->
            <div class="form-group boxcenter">
                <label>諮詢項目 <b>（可複選）</b></label>
                <div class="image-options task">
                    <img src="images/status1.jpg" class="condition-image" data-value="排列擁擠" alt="排列擁擠">
                    <img src="images/status2.jpg" class="condition-image" data-value="暴牙/兔寶寶" alt="暴牙/兔寶寶">
                    <img src="images/status3.jpg" class="condition-image" data-value="牙縫過大" alt="牙縫過大">
                    <img src="images/status4.jpg" class="condition-image" data-value="戽斗" alt="戽斗">
                </div>
                <button class="uncertain-button" type="button" id="uncertain-button">我不確定</button>
            </div>

            <!-- 縣市選擇 -->
            <div class="form-group">
                <label for="city">居住縣市：</label>
                <select id="city" name="city" required>
                    <option value="" selected disabled>請選擇縣市</option>
                </select>
            </div>

            <!-- 區域選擇 -->
            <div class="form-group">
                <label for="region">區域別：</label>
                <select id="region" name="region" required>
                    <option value="" selected disabled>請先選擇縣市</option>
                </select>
            </div>

            <div class="form-group">
                <label for="email">信箱：</label>
                <input type="email" id="email" name="email" placeholder="例如：oligner@example.com">
                <small id="email-warning" style="color: red; display: none;">信箱必須包含 @ 符號</small>
            </div>

            <!--隱私權  -->
            <div class="privacy-container">
                <input type="checkbox" id="privacy-checkbox">
                <label for="privacy-checkbox">我已閱讀並同意<a href="#" id="privacy-button">隱私條款</a></label>
            </div>

            <button type="button" id="next-button" disabled>下一步，拍照</button>
        </form>

        <a href="index.html" class="back-button">回上一頁</a>
        <footer>
            <p>© 2024 OLigner 歐耐恩隱形矯正
                <br>all rights reserved 版權所有
            </p>
            <h1 class="next71">製作公司: <a href="https://www.71next.com/" target="_blank"
                    rel="noopener noreferrer">秦毅數位科技現有公司</a>
            </h1>
        </footer>
        <div id="privacy-modal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h1>歐耐恩隱私權政策</h1>
                <p>非常歡迎您光臨「歐耐恩OLigner網站」（以下簡稱本網站），為了讓您能夠安心使用本網站的各項服務與資訊，特此向您說明本網站的隱私權保護政策，以保障您的權益，請您詳閱下列內容：</p>
                <!-- 隱私權條款內容... -->
            </div>
        </div>
    </div>

    <script>
        const citySelect = document.getElementById('city');
        const regionSelect = document.getElementById('region');
        const conditionImages = document.querySelectorAll('.condition-image');
        const uncertainButton = document.getElementById('uncertain-button');
        const selectedConditionInput = document.getElementById('selected-condition');
        const nextButton = document.getElementById('next-button');
        const phoneInput = document.getElementById('phone');
        const phoneInfo = document.getElementById('phone-info');
        const calculatedAgeInput = document.getElementById('calculated-age');
        const rocYearInput = document.getElementById('rocYear');
        const rocYearWarning = document.getElementById('rocYear-warning');
        const emailInput = document.getElementById('email');
        const emailWarning = document.getElementById('email-warning');
        const privacyCheckbox = document.getElementById('privacy-checkbox');

        let selectedConditions = [];

        //彈窗事件
        const modal = document.getElementById('privacy-modal');
        const privacyButton = document.getElementById('privacy-button');
        const closeButton = document.querySelector('.close-button');

        // 開啟彈窗
        privacyButton.addEventListener('click', () => {
            modal.classList.add('show');
        });

        // 關閉彈窗
        closeButton.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => {
            if (event.target === modal) closeModal();
        });

        function closeModal() {
            modal.classList.remove('show');
        }

        function calculateAge() {
            const currentYear = new Date().getFullYear();
            const rocYear = parseInt(document.getElementById("rocYear").value, 10);

            if (rocYear > 200) {
                rocYearWarning.style.display = 'block';
                nextButton.disabled = true;
                return;
            } else {
                rocYearWarning.style.display = 'none';
            }

            if (!rocYear) {
                return;
            }

            const birthYear = rocYear + 1911;
            const age = currentYear - birthYear;
            calculatedAgeInput.value = age;  // 儲存年齡於隱藏欄位
        }

        document.getElementById("rocYear").addEventListener("input", calculateAge);

        phoneInput.addEventListener('input', function () {
            const remainingDigits = 10 - phoneInput.value.length;
            phoneInfo.textContent = `電話格式：09 開頭，共 10 位數字，剩餘 ${remainingDigits} 位`;
            const isPhoneValid = phoneInput.value.match(/^09[0-9]{8}$/) !== null;
            phoneInput.setCustomValidity(isPhoneValid ? '' : '請填入有效的台灣手機號碼，09開頭共10位數');
            checkFormValidity();
        });
        emailInput.addEventListener('input', checkFormValidity);

        privacyCheckbox.addEventListener('change', checkFormValidity);

        function checkFormValidity() {
            const allFilled = requiredFields.every(field => field.value.trim() !== '');
            const conditionFilled = selectedConditionInput.value.trim() !== '';
            const isPhoneValid = phoneInput.value.match(/^09[0-9]{8}$/) !== null;
            const isEmailValid = emailInput.value === '' || emailInput.value.includes('@'); // 信箱可空白，若填寫需包含 '@'
            const isPrivacyChecked = privacyCheckbox.checked;

            nextButton.disabled = !(allFilled && conditionFilled && isPhoneValid && isEmailValid && isPrivacyChecked && rocYearWarning.style.display === 'none');

            // 顯示或隱藏信箱警告
            if (emailInput.value !== '' && !isEmailValid) {
                emailWarning.style.display = 'block';
            } else {
                emailWarning.style.display = 'none';
            }
        }
        
        emailInput.addEventListener('input', checkFormValidity);

        const form = document.getElementById('task-form-1');
        const requiredFields = Array.from(form.querySelectorAll('input[required], select[required]'));

        // 狀況圖片多選邏輯
        conditionImages.forEach(image => {
            image.addEventListener('click', function () {
                if (uncertainButton.classList.contains('selected')) {
                    uncertainButton.classList.remove('selected');
                    selectedConditions = [];
                }

                this.classList.toggle('selected');
                const value = this.getAttribute('data-value');

                if (this.classList.contains('selected')) {
                    selectedConditions.push(value);
                } else {
                    selectedConditions = selectedConditions.filter(cond => cond !== value);
                }

                selectedConditionInput.value = selectedConditions.join(', ');
                checkFormValidity();
            });
        });

        uncertainButton.addEventListener('click', function () {
            conditionImages.forEach(img => img.classList.remove('selected'));
            selectedConditions = [];
            this.classList.add('selected');
            selectedConditionInput.value = '我不確定';
            checkFormValidity();
        });

        fetch('regions.json')
            .then(response => response.json())
            .then(data => {
                Object.keys(data).forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });

                citySelect.addEventListener('change', () => {
                    const selectedCity = citySelect.value;
                    const regions = data[selectedCity] || [];
                    regionSelect.innerHTML = '<option value="" selected disabled>請選擇區域</option>';
                    regions.forEach(region => {
                        const option = document.createElement('option');
                        option.value = region;
                        option.textContent = region;
                        regionSelect.appendChild(option);
                    });
                });
            })
            .catch(error => console.error('無法載入縣市資料:', error));

        requiredFields.forEach(field => {
            field.addEventListener('input', checkFormValidity);
            field.addEventListener('change', checkFormValidity);
        });

        checkFormValidity();

        nextButton.addEventListener('click', () => {
            const formData = {
                task_name: form.task_name.value,
                condition: selectedConditionInput.value,
                name: form.name.value,
                rocYear: form.rocYear.value,
                age: calculatedAgeInput.value,  // 儲存計算後的年齡
                phone: form.phone.value,
                city: form.city.value,
                region: form.region.value,
                email: form.email.value
            };
            localStorage.setItem('taskData', JSON.stringify(formData));
            window.location.href = 'task1_camera.html';
        });

    </script>
</body>

</html>